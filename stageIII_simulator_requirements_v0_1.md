# stageIII_simulator 要件定義書 v0.1（ドラフト）
作成日: 2026-01-31  
対象: **低分子創薬における組み合わせ合成ステージ（StageIII）** を模したシミュレーター（Streamlit WebApp + Pythonパッケージ）

---

## 1. 目的と背景
### 1.1 目的
- StageIII（組み合わせ合成）において、**最大価値（最大 pIC50）化合物**を「できるだけ効率的に」見つけるための探索手法を比較する。
- 比較は、**Iterative な開示（実験）を繰り返して**、真の最大セル（正解）に到達するまでに要した **開示セル数 P**（および Top-k 到達までの P）で評価する。

### 1.2 スコープ
- スロット数: **2〜4（A, B, C, D）**
- 各スロットの候補 Building Block（BB）数: **各スロット10〜50（スロットごとに不均一を許容）**
- 総セル数（全組み合わせ）上限: **100,000**  
  - 超える場合は **シミュレーションは実行せず**、UI 上で条件再設定を促す。

### 1.3 非スコープ（現状）
- スロット間相互作用項の明示モデル化（相互作用は誤差 error に吸収）
- 複数手法を同条件で一括比較する UI（単一手法実行のみ）
- 再現性（固定 seed）を重視した設計

---

## 2. 用語
- **StageIII**: 前段階でスロットごとに候補 BB が絞られた後、総当たり組み合わせ空間の中から最大価値化合物を探索する段階。
- **セル / 組み合わせ**: 各スロットの BB 選択の組（例: A_i × B_j × C_k）。
- **開示（disclosure）**: Operator が選んだセルの値 y を環境が返すこと（実験を模擬）。
- **Operator**: 開示済み情報から次に開示すべきセルを提案する探索エージェント。
- **P**: 開示済みセル数（**ユニーク**なセルの総数）。初期開示も含む。  
  - 本シミュレータでは、初期開示および各ステップの開示は「**一括開示（バッチ）**」として扱う。  
  - Top-1/Top-k 到達判定がバッチ内で発生した場合でも、P は **そのバッチ終了時点のユニーク開示数**とする。
- **Top-k**: 価値上位 k 個のセル集合（正解集合）。Top-k 到達は、その集合のいずれかを **初めて開示したバッチ終了時点**とする。

---

## 3. データ生成（真の評価関数）
### 3.1 全体方針

- シミュレーション開始時に、**全組み合わせセルを事前生成**して N 次元テンソル（または同等の全列挙表現）を作る。
- 内部実装では、全セルを **線形index化した 1D 配列（長さ n_total）**として保持してよい（概念上は N 次元テンソル）。
  - `id -> (a,b,c,d)` および `(a,b,c,d) -> id` の相互変換関数を提供する。
  - y_true / y_obs は `y_true[id]`, `y_obs[id]` のように参照する。
- 各セルの値は以下で与える（pIC50想定）:

\[
y = bias + \sum_{i=1}^{N} main\_effect(slot_i, bb_i) + error
\]

※ slot bias（スロットごとの平均差を作るバイアス）は main_effect の生成側に吸収する（= 各スロットの主作用分布の平均がズレる）。

### 3.2 主作用（main effect）
- 各スロットごとに、各 BB の主作用を割り当てる。
- 主作用は **一様分布**でサンプリング。
- 主作用分布の範囲（下限・上限）は **全スロット共通**（ユーザ指定）。
- スロット間で平均を変えるため、各スロットに **slot_bias** を付与する:
  - slot_bias は **一様分布**でサンプリング（範囲は固定デフォルト、または将来UIで指定可能）。
  - 各 BB の主作用は `raw_main + slot_bias` とする。

### 3.3 誤差（error）
- 各セルにつき `Normal(0, σ^2)` からサンプリングした後、**ユーザ指定の上下限で clip**。
- ユーザは誤差の **上下限のみ**を指定する（σは内部デフォルト）。
- 相互作用・実験誤差などは error に吸収（明示モデル化しない）。

### 3.4 pIC50 レンジ（6〜10）
- 本シミュレータでは、内部的に以下の2種類の値を区別する:
  - **y_true**: 生成直後の真値（bias + Σ main_effect + error）
  - **y_obs**: Operator に開示される観測値（y_true を **[5,11] で clip** したもの）
- 生成された値は pIC50 を想定し、表示・解釈レンジは **6〜10** を標準とする（許容範囲は **5〜11**）。
- 実装方針（要件）:
  - Operator が参照する値（開示される値）は **常に y_obs** とする。
  - UI表示・統計の pIC50 値も **y_obs** を用いる。
  - **正解（Top-1 / Top-k）の判定は y_true に基づいて行う**（clip による同値最大の多発を避けるため）。
  - **y_true の argmax が一意でない（同値最大）場合は条件不良**として Matrix を再生成してやり直す。  
    - 最大5回まで再生成し、5回失敗する場合は設定条件が悪いと判断し処理を停止してエラー表示する。

### 3.5 正解セル（答え）
- 正解（Top-1）は **argmax(y_true)** のセル（単一）である。
- 同値最大が複数発生した場合（y_true の argmax が一意でない場合）は、Matrix生成をやり直す（最大5回、失敗時はエラー）。
- Top-k は **y_true の上位 k セル集合**として定義する。


---

## 4. シミュレーションの流れ
### 4.1 事前チェック
- スロット数 N（2〜4）と各スロットの BB 数の積 `n_total` を計算。
- `n_total > 100,000` の場合:
  - シミュレーションは実行せず、UIで「条件を下げてください」を表示。

### 4.2 初期開示（初期条件）
- システムが各スロットから BB を 1 つずつランダムに選ぶ（A', B', C', D'）。
- 初期開示は、次のセル集合を **和集合**として開示する:
  - Nスロットの場合:  
    **「N-1 個のスロットを固定して、残り 1 スロットを全開示」** をスロットごとに実施する。  
    例（3スロット）:
    - (A', B', C_all), (A', B_all, C'), (A_all, B', C') の和集合
- 初期開示セル集合は和集合で定義するため、重複があり得る（中心セルなど）。  
  - 開示済みセルは **集合（set）として管理**し、開示数・Pは **ユニーク件数**で数える。
- 初期開示セル集合に正解セル（argmax）が含まれた場合:
  - 初期 BB 選択をやり直す（再抽選）。

> 注: 初期開示セル数は N と各スロット候補数により増えるため、UI上に「初期開示セル数」を表示する。

### 4.3 反復ステップ
- 反復 t=1,2,... で以下を行う:
  1) Operator が、未開示セルから **K 個（1〜5）**選択（このK値はIterationやステップごとに変えるものではない）
  2) 環境が K 個の y を開示
  3) Operator は **K 個の開示データを加えてまとめて** 学習・更新（逐次更新ではない）
  4) 正解セルが開示されたら、その試行を終了

### 4.4 記録する指標
- **P_top1**: 正解セル（Top-1）に到達するまでに開示したセル数（**ユニーク開示数**、初期開示含む）。  
  - 到達があるバッチ内で起きても、P は **そのバッチ終了時点**のユニーク開示数とする。
- **P_topk**: Top-k のいずれかに到達するまでに開示したセル数（**ユニーク開示数**、初期開示含む）。  
  - 到達があるバッチ内で起きても、P は **そのバッチ終了時点**のユニーク開示数とする。
- **n_steps**: 反復ステップ数（初期開示は含めない）
- **runtime_ms**: 1試行あたりの処理時間（ミリ秒、可能なら）

---

## 5. Operator（探索戦略）
共通:
- 未開示セルからのみ選択（既開示セルの再選択は禁止）。
- 1ステップで K 個をまとめて選び、まとめてモデル更新する。

### 5.1 戦略①: 完全ランダム
- 未開示セルから一様ランダムに K 個を選択。

### 5.2 戦略②: 古典的 Free-Wilson（リッジ回帰）
- モデル: Free-Wilson 線形モデル（スロット×BB の one-hot 係数）
- 推定:
  - 内部表現は **reference coding（基準カテゴリ固定）**
  - 学習は **Ridge 回帰をデフォルト**とする
  - 係数の解釈表示時に **sum-to-zero** へ変換して表示可能
- 次候補提案:
  - 推定値 μ_pred の高いセルを上位から K 個選択（探索性なし、搾取中心）
  - 同点時の tie-break はランダム
- 正則化強度（alpha）はデフォルト **1.0** とする（UIには出さず固定でよい）。


### 5.3 戦略③: ベイジアン Free-Wilson（MAP + Laplace相当 / 部分閉形式）

- 前提:
  - 線形ガウス + 正規事前（係数 prior）を仮定する。
    - 係数 \(\theta\) の事後（\(\sigma\) 固定時）は閉形式で計算可能（= MAP が閉形式）。
    - Laplace 近似による係数共分散も解析的に計算可能。
  - 観測ノイズは \(\sigma\)（標準偏差）をデータから推定する（Empirical Bayes / joint MAP 的な点推定）。
    - 初期値: \(\sigma \leftarrow \sigma_{\text{init}}\)（デフォルトは後述）
    - 更新式（1反復ごと）:
      - \(\hat{\theta}\) を現在の \(\sigma\) で計算（後述の閉形式）
      - 残差 \(r = y - X\hat{\theta}\)
      - \(\hat{\sigma} \leftarrow \sqrt{\mathrm{Var}(r)}\)（ddof=1 相当）
      - \(\sigma \leftarrow \max(\hat{\sigma}, \sigma_{\min})\)
    - 反復回数: 最大 5 回、収束判定: \(|\sigma_{\text{new}}-\sigma_{\text{old}}|/\sigma_{\text{old}} < 1e-3\)
  - prior 分散（正則化強度）は slot ごとに同一（等方的）とし、\(\Lambda^{-1} = \alpha I\) とする。
    - \(\alpha\) は戦略②（Ridge）のデフォルト \(\alpha\) と同一値を用いる（整合性のため）。


- 目的関数（負の対数事後）:
  - ユーザ指定式を採用:
    \[
    L(\theta)=\frac{1}{2\sigma^2}\|y-X\theta\|^2+\frac{1}{2}\theta^\top\Lambda^{-1}\theta(+ const)
    \]

- 推定（MAP）:
  - 内部表現は reference coding とし、\(\sigma\) 固定時の閉形式解（MAP）を計算する:
    \[
    \hat{\theta}=(X^\top X+\sigma^2\Lambda^{-1})^{-1}X^\top y
    \]
  - \(\sigma\) 推定は、以下のような反復更新を想定（詳細は実装で確定）:
    1. 初期値 \(\sigma\) を設定
    2. 上式で \(\hat{\theta}\) を計算
    3. 残差から \(\hat{\sigma}\) を更新（例: 残差分散に基づく更新）
    4. \(\sigma \leftarrow \max(\hat{\sigma}, \sigma_{\min})\) で下限クリップ
    5. 収束するまで数回反復

  - \(\sigma\) と \(\Lambda\) が与えられたとき、事後は閉形式で計算する:
    - \(\Sigma_{\theta} = \left(\frac{1}{\sigma^2}X^\top X + \Lambda^{-1}\right)^{-1}\)
    - \(\mu_{\theta} = \Sigma_{\theta}\left(\frac{1}{\sigma^2}X^\top y\right)\)
    - MAP 推定値は \(\hat{\theta} = \mu_{\theta}\)


- Laplace 近似（係数共分散）:
  - ヘッセ行列:
    \[
    H=\frac{1}{\sigma^2}X^\top X+\Lambda^{-1}
    \]
  - 係数共分散（Laplace）:
    \[
    \Sigma_\theta \approx H^{-1}
    \]

- 表示（sum-to-zero）:
  - 推定は reference coding で行い、出力表示は slot ごとの sum-to-zero 表現へ変換する（予測値は不変）。

- 予測不確実性（用途別の使い分け）:
  - 提案（UCB 等の探索項）で用いる不確実性（係数由来）:
    \[
    \sigma_{\text{param}}(x)^2 = x^\top \Sigma_\theta x
    \]
  - 表示（予測区間）で用いる不確実性（係数由来 + 観測ノイズ）:
    \[
    \sigma_{\text{total}}(x)^2 = x^\top \Sigma_\theta x + \sigma^2
    \]

- 次候補提案（UCB）:
  - \[ acq = \mu_{pred} + \beta \cdot \sigma_{pred} \]
  - β は固定デフォルト **1.0**
  - σ_pred は **係数事後由来の不確実性のみ**（観測ノイズは含めない）
  - acq の高いセルから K 個選択（tie はランダム）

---

## 6. 入力パラメータ（UI）
### 6.1 ユーザが指定するパラメータ
- 手法（Operator戦略）: {Random, FW-Ridge, Bayesian-FW-UCB}
- Simulation 回数（試行数）: int（例: 10〜1000）
- スロット数: {2,3,4}
- 各スロットの BB 数: int（各スロット 10〜50）
  - スロットごとに不均一を許容する（例: A=30, B=10, C=20）。
  - 総セル数は各スロットBB数の積で計算し、**100,000 を超える場合は実行不可**。
- 主作用の一様分布範囲: [main_low, main_high]
- 誤差の clip 範囲: [err_low, err_high]
- 1ステップで開示するセル数 K: {1,2,3,4,5}
- Top-k の k: int {5, 10, 20}

### 6.2 システム内部デフォルト（ユーザが触らない）
- global bias:
  - \(bias \sim \mathrm{Uniform}(7.5, 8.5)\)（pIC50の中心が8付近になるように）
- slot_bias:
  - 各スロットごとに \(slot\_bias \sim \mathrm{Uniform}(-0.5, 0.5)\)
- error の正規分布（データ生成時）:
  - ユーザ指定の clip 範囲を \([err_{low}, err_{high}]\) とし、生成用の標準偏差は
    - \(\sigma_{gen} = (err_{high}-err_{low})/6\)（±3σ が概ね範囲に収まる想定）
- Free-Wilson Ridge の正則化強度:
  - \(\alpha = 1.0\)
- Bayesian FW の \(\sigma\) 推定（EB）用デフォルト:
  - \(\sigma_{init} = \sigma_{gen}\)
  - \(\sigma_{min} = 0.05\)
  - 反復最大回数 5、収束判定 1e-3


---

## 7. 出力（UI）
表示（必須）:
- P_top1 のヒストグラム
- P_top1 の統計量: Median, Mean, STD, Max, Min
- P_topk の統計量: Median, Mean, STD, Max, Min（kはユーザ指定）
- 実行条件（パラメータのサマリ）

ダウンロード（必須）:
- 各試行の結果テーブル（CSV）
  - trial_id
  - method
  - n_total_cells
  - n_initial_disclosed
  - k_value
  - topk_k
  - P_top1
  - P_topk
  - n_steps
  - hit_in_initial_topk（初期開示でTop-k到達したか: bool）

ログ（最小限）:
- 実行開始・終了、総試行数、総セル数、初期開示セル数、エラー（条件超過など）

---

## 8. 画面仕様（Streamlit）
- サイドバー:
  - パラメータ入力（手法、試行数、スロット数、BB数、主作用範囲、誤差範囲、K、Top-k）
  - 実行ボタン
- メイン:
  - 条件チェック結果（総セル数、初期開示セル数、制限超過時のエラー）
  - 実行中ステータス（プログレスバー）
  - 図: ヒストグラム
  - 表: 統計量と試行別結果
  - CSV ダウンロードボタン

---

## 9. 非機能要件
- 性能:
  - 総セル数 <= 100,000 の範囲で、UIが現実的な時間で応答する（目安: 数分以内）
- 信頼性:
  - argmax が一意でない場合は再生成して回避
  - 初期開示に正解が含まれる場合は初期BB抽選をやり直し
- 保守性:
  - シミュレーションコア（Python API）と UI（Streamlit）を分離
  - Operator を戦略クラスとして差し替え可能にする

---

## 10. テスト方針（最小）
- 単体テスト
  - セル数制限判定
  - 初期開示セル集合のサイズと重複除去
  - argmax 一意性チェック
  - 各 Operator が「既開示セルを選ばない」こと
- 受入テスト
  - 2/3/4 スロットの代表ケースで UI 実行し、CSV が出ること
  - Top-k 指標が計算されること


