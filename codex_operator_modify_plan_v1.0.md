# codex_operator_modify_plan_v1.0

Operator 戦略拡張 実装プラン（v1.0）

---

## 1. 目的
- Operatorの戦略を段階的に拡張し、主作用のみ → 離散相互作用 → 連続相互作用の比較が可能なラインナップにする。
- 主作用と相互作用の分離を厳密化（Centering制約）。
- 連続相互作用は Smooth 相互作用の予測を主対象とし、cliff由来のspikeは難しくなる設計とする。
- ベイズ系は経験ベイズ（動的に事前α更新）を前提とする。

---

## 2. 前提仕様（確定事項）
- 相互作用は **2因子間（pairwise）** のみ扱う。
- 連続相互作用用の高次元ベクトルは **256 または 512次元**。
- 非線形は **1回だけ**（例：Sigmoid / Tanh / GELU等）を通す。
- 次元削減は **PCA** を使用。
- 主作用・相互作用の分離は **Centering制約** を入れる（double-centering相当）。
- ベイズ系は **経験ベイズ（動的事前α更新）** を実装前提とする。

---

## 2.1 確定ポイントの詳細解説 + 推奨
1. **Operatorへ渡すデータの定義（どこで生成し、何を渡すか）**
   - BB単位での特徴量（高次元ベクトル→PCA後の低次元ベクトル）を生成側で一度作ってOperatorに渡す。
2. **高次元変換の具体式（W1/W2・非線形・seed）**
   - 固定ランダム変換（試行rngから生成）+ 非線形1回。
   - 例: z(d=16) -> h=64 -> v_high=256/512 の2層MLP風変換、tanh または GELU を1回だけ。
   - WはGaussian/orthogonal、bはGaussianでOK。試行ごとに固定し、Matrixに保存して再現性を確保。
3. **PCAのfit対象と更新頻度**
   - スロットごとに「全BB」から1回fit、固定次元（16次元）。
   - PCAモードは固定次元のみ（寄与率モードは使わない）。
4. **連続相互作用モデル（低ランク双線形 vs 回帰）**
   - 明示的な回帰（kron特徴量）
     - 例: u_i (p), v_j (p) → phi = kron(u_i, v_j)
   - 低ランク双線形（U diag(w) V^T）も実装して選択できるようにする。
5. **離散相互作用とcenteringの具体化**
   - 特徴設計で双中心化を満たす基底を使う。
   - 実装案: C_s = I - (1/n_s)11^T, C_t = I - (1/n_t)11^T を使って、相互作用の基底を C_s ⊗ C_t に射影した形で作る。
6. **Empirical Bayes（α更新）の適用範囲**
   - 全係数共有・毎step更新。
7. **予測計算の効率**
   - 主作用＋相互作用を分解合算。
   - 相互作用は「各ペアの係数表」から直接合算する方式にする。
   - 連続相互作用は u_i / v_j を使って「ペア係数を事前計算」し、そこから参照する。
8. **UI/設定の追加範囲**
   - 最小構成を固定値で出し、Advancedに寄せる。
   - 基本: high_dim=256, pca_dim=16, nonlinearity=tanh を固定。
   - Advancedで high_dim=512、pca_dim={4,8,16,32,64} を許容。
   - PCA標準化は center only のみ。
   - MLP中間次元は最大64、下限4または8を許容。

---

## 3. 戦略ラインナップ（実装対象）
1. Random  
2. Free-Wilson OLS（主作用のみ）  
3. Free-Wilson Ridge（主作用のみ）  
4. ベイズFree-Wilson（主作用のみ）  
5. Free-Wilson OLS（主作用＋離散的相互作用）  
6. Free-Wilson Ridge（主作用＋離散的相互作用）  
7. ベイズFree-Wilson（主作用＋離散的相互作用）  
8. Free-Wilson OLS（主作用＋連続的相互作用）  
9. Free-Wilson Ridge（主作用＋連続的相互作用）  
10. ベイズFree-Wilson（主作用＋連続的相互作用）

---

## 4. 連続相互作用（Smooth向け）の設計方針
### 4.1 生成側（既存モデル）
- BB埋め込み（例：d=16）を各BBに付与。
- 相互作用は埋め込みに基づく Smooth + Spike 混合。

### 4.2 Operator入力ベクトル設計（新）
- **BB埋め込み → 高次元変換 → 非線形（1回）** を通したベクトルを Operator に提供。
- 次元： **256 or 512**。
- 変換は **逆推定が容易でない**ようにする（線形変換のみは禁止）。
  - 例：`v_high = φ(W2 * (W1 * z + b1) + b2)` ただし活性化は1回のみ。
- 固定ランダム変換（試行rngから生成）を採用。
  - 例: z(d=16) -> h=64 -> v_high=256/512 の2層MLP風変換。
  - 非線形は tanh または GELU を1回だけ適用。
  - WはGaussian/orthogonal、bはGaussianでOK。
- 変換パラメータは試行ごとに固定し、Matrix側に保存して再現性を確保。
- MLP中間次元hは最大64、Advancedで4/8など低い条件も許容。

### 4.3 Operator側の推定パイプライン
1. 高次元ベクトルを **PCAで低次元化**。
   - スロットごとに全BBで1回fitし、固定次元（16次元）で使用。
   - PCAモードは固定次元のみ（寄与率モードは使わない）。
   - PCA標準化は center only のみ。
2. 低次元空間で **pairwise相互作用** を推定。
   - 明示的回帰（kron特徴量）をデフォルトにする。
   - 低ランク双線形（U diag(w) V^T）も選択可能にする。
3. Smooth相互作用に寄せた構造のため、spike（cliff）は原理的に捕捉しづらい設計。

---

## 5. Centering制約（主作用/相互作用の分離）
- 主作用/相互作用の分離を保つため、相互作用テーブルに **double-centering** 相当の制約を入れる。
  - 各スロットの平均が0になるように調整。
  - 主作用推定と相互作用推定が混ざらないよう統一ルールで実装する。
- 特徴設計で双中心化を満たす基底を使う。
  - C_s = I - (1/n_s)11^T, C_t = I - (1/n_t)11^T を用い、相互作用の基底を C_s ⊗ C_t に射影した形で作る。

---

## 6. ベイズ戦略（経験ベイズ化の方針）
- 事前分布のαは固定ではなく **経験ベイズで動的更新** する。
- 予定方針：
  - 学習データからエビデンス最大化 or 周辺尤度近似でαを更新
  - 更新頻度は **毎step** とする
- 主作用のみ／離散相互作用／連続相互作用の各ケースで同一方針を適用し、公平性を確保する。
- αは全係数共有で運用する。

---

## 7. 実装ステップ（高レベル）
1. **データインターフェース整理**
   - Operatorに渡す新規高次元ベクトル（256/512）を追加。
   - BB単位の特徴量（高次元→PCA後の低次元）を生成側で一度作り、Operatorへ渡す。
2. **モデル拡張（主作用のみ）**
   - OLS/Ridge/ベイズの主作用モデルを整備（既存の枠組みに統合）。
3. **離散相互作用の実装**
   - pairwise相互作用の回帰項を追加。
   - Centering制約を組み込み。
4. **連続相互作用の実装**
   - 高次元 → PCA → pairwise推定のパイプライン追加。
   - 明示的回帰（kron特徴量）をデフォルトにし、低ランク双線形も選択可能にする。
5. **ベイズの経験ベイズ化**
   - α更新ループを共通モジュール化。
6. **評価・妥当性チェック**
   - 主作用/相互作用の分離、過学習傾向、性能差の確認。
   - 予測は主作用＋相互作用の分解合算で効率化する。
   - 相互作用は各ペアの係数表から直接合算し、連続相互作用は u_i / v_j からペア係数を事前計算する。

---

## 8. パラメータ・UI観点（最小構成）
- 高次元ベクトル次元：**256固定**（Advancedで512を許容）
- PCA次元：**16固定**（Advancedで4/8/32/64を許容）
- 非線形：**tanh固定**（AdvancedでGELUを許容）
- PCA標準化：**center only固定**
- MLP中間次元：**64固定**（Advancedで4/8/16/32を許容）
- Ridge強度 / ベイズ事前α（経験ベイズで更新）

---

## 9. 決定事項（まとめ）
- OperatorへはBB単位の特徴量（高次元→PCA低次元）を生成側で渡す。
- 高次元変換は固定ランダム2層（z(d=16) → h=64 → v_high=256/512）、非線形は1回のみ。
- PCAはスロットごと全BBで1回fit、固定次元16で推定に利用。
- PCAモードは固定次元のみ、標準化はcenter only。
- 連続相互作用はkron回帰をデフォルト、低ランク双線形も選択可能。
- 離散相互作用はC_s ⊗ C_t基底でdouble-centeringを保証。
- Empirical Bayesのαは全係数共有・毎step更新。
- 予測は主作用＋相互作用を分解合算し、相互作用はペア係数表で高速化。
- UI最小構成は high_dim=256 / pca_dim=16 / nonlinearity=tanh / mlp_hidden=64、Advancedで拡張。

---

## 10. 成功判定（最低限）
- 主作用と相互作用が独立に推定される（centeringの確認）。
- 連続相互作用はSmoothに強いが、spikeには弱い挙動が出る。
- OLS/Ridge/ベイズの比較で性能差が再現性を持って観測できる。
