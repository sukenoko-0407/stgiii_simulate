# codex_operator_modify_plan_v1.0

Operator 戦略拡張 実装プラン（v1.0）

---

## 1. 目的
- Operatorの戦略を段階的に拡張し、主作用のみ → 離散相互作用 → 連続相互作用の比較が可能なラインナップにする。
- 主作用と相互作用の分離を厳密化（Centering制約）。
- 連続相互作用は Smooth 相互作用の予測を主対象とし、cliff由来のspikeは難しくなる設計とする。
- ベイズ系は経験ベイズ（動的に事前α更新）を前提とする。

---

## 2. 前提仕様（確定事項）
- 相互作用は **2因子間（pairwise）** のみ扱う。
- 連続相互作用用の高次元ベクトルは **256 または 512次元**。
- 非線形は **1回だけ**（例：Sigmoid / Tanh / GELU等）を通す。
- 次元削減は **PCA** を使用。
- 主作用・相互作用の分離は **Centering制約** を入れる（double-centering相当）。
- ベイズ系は **経験ベイズ（動的事前α更新）** を実装前提とする。

---

## 3. 戦略ラインナップ（実装対象）
1. Random  
2. Free-Wilson OLS（主作用のみ）  
3. Free-Wilson Ridge（主作用のみ）  
4. ベイズFree-Wilson（主作用のみ）  
5. Free-Wilson OLS（主作用＋離散的相互作用）  
6. Free-Wilson Ridge（主作用＋離散的相互作用）  
7. ベイズFree-Wilson（主作用＋離散的相互作用）  
8. Free-Wilson OLS（主作用＋連続的相互作用）  
9. Free-Wilson Ridge（主作用＋連続的相互作用）  
10. ベイズFree-Wilson（主作用＋連続的相互作用）

---

## 4. 連続相互作用（Smooth向け）の設計方針
### 4.1 生成側（既存モデル）
- BB埋め込み（例：d=16）を各BBに付与。
- 相互作用は埋め込みに基づく Smooth + Spike 混合。

### 4.2 Operator入力ベクトル設計（新）
- **BB埋め込み → 高次元変換 → 非線形（1回）** を通したベクトルを Operator に提供。
- 次元： **256 or 512**。
- 変換は **逆推定が容易でない**ようにする（線形変換のみは禁止）。
  - 例：`v_high = φ(W2 * (W1 * z + b1) + b2)` ただし活性化は1回のみ。

### 4.3 Operator側の推定パイプライン
1. 高次元ベクトルを **PCAで低次元化**（次元数は固定 or ハイパラ化）。
2. 低次元空間で **pairwise相互作用** を推定（低ランク双線形/回帰など）。
3. Smooth相互作用に寄せた構造のため、spike（cliff）は原理的に捕捉しづらい設計。

---

## 5. Centering制約（主作用/相互作用の分離）
- 主作用/相互作用の分離を保つため、相互作用テーブルに **double-centering** 相当の制約を入れる。
  - 各スロットの平均が0になるように調整。
  - 主作用推定と相互作用推定が混ざらないよう統一ルールで実装する。

---

## 6. ベイズ戦略（経験ベイズ化の方針）
- 事前分布のαは固定ではなく **経験ベイズで動的更新** する。
- 予定方針：
  - 学習データからエビデンス最大化 or 周辺尤度近似でαを更新
  - 更新頻度（毎イテレーション/バッチ/世代）を明確化
- 主作用のみ／離散相互作用／連続相互作用の各ケースで同一方針を適用し、公平性を確保する。

---

## 7. 実装ステップ（高レベル）
1. **データインターフェース整理**
   - Operatorに渡す新規高次元ベクトル（256/512）を追加。
2. **モデル拡張（主作用のみ）**
   - OLS/Ridge/ベイズの主作用モデルを整備（既存の枠組みに統合）。
3. **離散相互作用の実装**
   - pairwise相互作用の回帰項を追加。
   - Centering制約を組み込み。
4. **連続相互作用の実装**
   - 高次元 → PCA → pairwise推定のパイプライン追加。
5. **ベイズの経験ベイズ化**
   - α更新ループを共通モジュール化。
6. **評価・妥当性チェック**
   - 主作用/相互作用の分離、過学習傾向、性能差の確認。

---

## 8. パラメータ・UI観点（最小構成）
- 高次元ベクトル次元：256/512（固定 or Advanced設定）
- PCA次元：固定数（例：16/32/64）または比率（例：95%）
- Ridge強度 / ベイズ事前α（経験ベイズで更新）

---

## 9. 未確定事項（要決定）
- PCA次元のデフォルト値（固定値 or 目標寄与率）。
- 非線形関数の候補（Sigmoid/Tanh/GELU 等）を1種に固定するか。
- 高次元変換の具体式（可逆になりにくい設計にする）。

---

## 10. 成功判定（最低限）
- 主作用と相互作用が独立に推定される（centeringの確認）。
- 連続相互作用はSmoothに強いが、spikeには弱い挙動が出る。
- OLS/Ridge/ベイズの比較で性能差が再現性を持って観測できる。

